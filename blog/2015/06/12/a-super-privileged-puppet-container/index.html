<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="James Shubin">

	<title>A super privileged Puppet container - https://purpleidea.com/</title>
	<link rel="canonical" href="https://purpleidea.com/blog/2015/06/12/a-super-privileged-puppet-container/">

	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/font-awesome.css" rel="stylesheet">
	<link href="/css/custom.css" rel="stylesheet">
	<link href="/css/staticman.css" rel="stylesheet">

	
</head>
<body>
	<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
					<span class="sr-only">Toggle Navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="https://purpleidea.com/">purpleidea.com</a>
			</div>
			<div class="collapse navbar-collapse navbar-ex1-collapse">
				<ul class="nav navbar-nav">

					<li><a href="/about/">about</a></li>
					<li><a href="/blog/">blog</a></li>
					<li><a href="/contact/">contact</a></li>
					<li><a href="/misc/">misc</a></li>
					<li><a href="/talks/">talks</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container">

	<div class="row">
		<div class="col-md-9">
			<div class="well well-sm">
					<h3><strong>A super privileged Puppet container</strong><br><small></small></h3>
					<hr>
					<p>In this new crazy world of <a href="https://en.wikipedia.org/wiki/Docker_%28software%29">containers</a> and immutable hosts, one might still want to run previous generation software such as <a href="https://duckduckgo.com/l/?kh=-1&uddg=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FPuppet_(software)">Puppet</a> on a current generation <a href="https://www.projectatomic.io/">Atomic host</a>. This article will explain how you can do that, and offer some <a href="https://github.com/purpleidea/spc-puppet-apply">proof of concept code</a>.</p>

<p>The atomic host doesn&rsquo;t provide a <a href="https://en.wikipedia.org/wiki/Yellowdog_Updater,_Modified">yum</a> or <a href="https://fedoraproject.org/wiki/Dnf">dnf</a> command, because the software is pre-baked into a read-only <code>/usr/</code> partition. To &ldquo;<em>install</em>&rdquo; (to use) additional software, it usually needs to be distributed and run as a container.</p>

<p>The <code>Dockerfile</code> which describes the docker container that we will build, has two important sections:</p>

<pre><code>ENV FACTER_fqdn=localhost
ENTRYPOINT [&quot;puppet&quot;, &quot;apply&quot;]
</code></pre>

<p>The <a href="https://docs.docker.com/reference/builder/#entrypoint"><code>ENTRYPOINT</code></a> verb causes docker to run the puppet command that we built into the container, when the container is run with externally provided arguments. The <a href="https://docs.docker.com/reference/builder/#env"><code>ENV</code></a> verb causes some <em>facter</em> errors to be suppressed, since <em>facter</em> isn&rsquo;t running on the host. The <a href="https://github.com/purpleidea/spc-puppet-apply/blob/master/Dockerfile">rest of the file</a> contains boilerplate and other build/run dependencies.</p>

<p>You can build this container yourself manually, or if you are an <a href="https://github.com/purpleidea/oh-my-vagrant">Oh-My-Vagrant</a> user, then you can use the supplied <a href="https://github.com/purpleidea/spc-puppet-apply/blob/master/omv.yaml">omv.yaml</a> file to build the container automatically. A build with Oh-My-Vagrant looks like this:</p>

<pre><code>$ time vup omv1
Bringing machine 'omv1' up with 'libvirt' provider...
==&gt; omv1: Creating image (snapshot of base box volume).
==&gt; omv1: Creating domain with the following settings...
==&gt; omv1:  -- Name:              omv_omv1
==&gt; omv1:  -- Domain type:       kvm
==&gt; omv1:  -- Cpus:              1
==&gt; omv1:  -- Memory:            512M
==&gt; omv1:  -- Base box:          centos-7.1-docker
==&gt; omv1:  -- Storage pool:      default
==&gt; omv1:  -- Image:             /var/lib/libvirt/images/omv_omv1.img
==&gt; omv1:  -- Volume Cache:      default
==&gt; omv1:  -- Kernel:            
==&gt; omv1:  -- Initrd:            
==&gt; omv1:  -- Graphics Type:     vnc
==&gt; omv1:  -- Graphics Port:     5900
==&gt; omv1:  -- Graphics IP:       127.0.0.1
==&gt; omv1:  -- Graphics Password: Not defined
==&gt; omv1:  -- Video Type:        cirrus
==&gt; omv1:  -- Video VRAM:        9216
==&gt; omv1:  -- Keymap:            en-us
==&gt; omv1:  -- Command line : 
==&gt; omv1: Starting domain.
==&gt; omv1: Waiting for domain to get an IP address...
==&gt; omv1: Waiting for SSH to become available...
==&gt; omv1: Starting domain.
==&gt; omv1: Waiting for domain to get an IP address...
==&gt; omv1: Waiting for SSH to become available...
==&gt; omv1: Creating shared folders metadata...
==&gt; omv1: Setting hostname...
==&gt; omv1: Rsyncing folder: /home/james/code/oh-my-vagrant/vagrant/ =&gt; /vagrant
==&gt; omv1: Configuring and enabling network interfaces...
==&gt; omv1: Updating /etc/hosts file on active guest machines...
==&gt; omv1: Running provisioner: shell...
    omv1: Running: inline script
==&gt; omv1: Running provisioner: shell...
    omv1: Running: inline script
==&gt; omv1: Running provisioner: docker...
    omv1: Configuring Docker to autostart containers...
==&gt; omv1: Running provisioner: docker...
    omv1: Configuring Docker to autostart containers...
==&gt; omv1: Building Docker images...
==&gt; omv1: -- Path: /vagrant/docker/spc-puppet-apply
==&gt; omv1: Sending build context to Docker daemon 122.9 kB
==&gt; omv1: Sending build context to Docker daemon 
==&gt; omv1: Step 0 : FROM centos:7
==&gt; omv1:  ---&gt; 0114405f9ff1
==&gt; omv1: Step 1 : MAINTAINER James Shubin &lt;james@shubin.ca&gt;
==&gt; omv1:  ---&gt; Running in 2dbdc37494e9
==&gt; omv1:  ---&gt; e154b3cfed7f
==&gt; omv1: Removing intermediate container 2dbdc37494e9
==&gt; omv1: Step 2 : RUN echo Hello from purpleidea and aweiteka &gt; README
==&gt; omv1:  ---&gt; Running in 97475154152f
==&gt; omv1:  ---&gt; e4728d71caac
==&gt; omv1: Removing intermediate container 97475154152f
==&gt; omv1: Step 3 : ADD el7-puppet.repo /etc/yum.repos.d/
==&gt; omv1:  ---&gt; c591e0a9a54d
==&gt; omv1: Removing intermediate container 24e55893313c
==&gt; omv1: Step 4 : ADD RPM-GPG-KEY-puppetlabs /etc/pki/rpm-gpg/
==&gt; omv1:  ---&gt; 223549fbf661
==&gt; omv1: Removing intermediate container 2bceb998f1c3
==&gt; omv1: Step 5 : RUN yum install -y puppet
==&gt; omv1:  ---&gt; Running in e44c9cf55dc5
==&gt; omv1: Loaded plugins: fastestmirror
==&gt; omv1: Determining fastest mirrors
==&gt; omv1:  * base: centos.mirror.vexxhost.com
==&gt; omv1:  * extras: mirror.gpmidi.net
==&gt; omv1:  * updates: centos.mirror.vexxhost.com
==&gt; omv1: Resolving Dependencies
==&gt; omv1: --&gt; Running transaction check
==&gt; omv1: ---&gt; Package puppet.noarch 0:3.7.5-1.el7 will be installed
==&gt; omv1: --&gt; Processing Dependency: ruby &gt;= 1.8 for package: puppet-3.7.5-1.el7.noarch
==&gt; omv1: --&gt; Processing Dependency: facter &gt;= 1:1.7.0 for package: puppet-3.7.5-1.el7.noarch
==&gt; omv1: --&gt; Processing Dependency: ruby &gt;= 1.8.7 for package: puppet-3.7.5-1.el7.noarch
==&gt; omv1: --&gt; Processing Dependency: hiera &gt;= 1.0.0 for package: puppet-3.7.5-1.el7.noarch
==&gt; omv1: --&gt; Processing Dependency: rubygem-json for package: puppet-3.7.5-1.el7.noarch
==&gt; omv1: --&gt; Processing Dependency: libselinux-utils for package: puppet-3.7.5-1.el7.noarch
==&gt; omv1: --&gt; Processing Dependency: ruby-augeas for package: puppet-3.7.5-1.el7.noarch
==&gt; omv1: --&gt; Processing Dependency: ruby(selinux) for package: puppet-3.7.5-1.el7.noarch
==&gt; omv1: --&gt; Processing Dependency: /usr/bin/ruby for package: puppet-3.7.5-1.el7.noarch
==&gt; omv1: --&gt; Processing Dependency: ruby-shadow for package: puppet-3.7.5-1.el7.noarch
==&gt; omv1: --&gt; Running transaction check
==&gt; omv1: ---&gt; Package facter.x86_64 1:2.4.3-1.el7 will be installed
==&gt; omv1: --&gt; Processing Dependency: net-tools for package: 1:facter-2.4.3-1.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: virt-what for package: 1:facter-2.4.3-1.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: pciutils for package: 1:facter-2.4.3-1.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: dmidecode for package: 1:facter-2.4.3-1.el7.x86_64
==&gt; omv1: ---&gt; Package hiera.noarch 0:1.3.4-1.el7 will be installed
==&gt; omv1: ---&gt; Package libselinux-ruby.x86_64 0:2.2.2-6.el7 will be installed
==&gt; omv1: ---&gt; Package libselinux-utils.x86_64 0:2.2.2-6.el7 will be installed
==&gt; omv1: ---&gt; Package ruby.x86_64 0:2.0.0.598-24.el7 will be installed
==&gt; omv1: --&gt; Processing Dependency: ruby-libs(x86-64) = 2.0.0.598-24.el7 for package: ruby-2.0.0.598-24.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: rubygem(bigdecimal) &gt;= 1.2.0 for package: ruby-2.0.0.598-24.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: ruby(rubygems) &gt;= 2.0.14 for package: ruby-2.0.0.598-24.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: libruby.so.2.0()(64bit) for package: ruby-2.0.0.598-24.el7.x86_64
==&gt; omv1: ---&gt; Package ruby-augeas.x86_64 0:0.4.1-3.el7 will be installed
==&gt; omv1: --&gt; Processing Dependency: augeas-libs &gt;= 0.8.0 for package: ruby-augeas-0.4.1-3.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: libaugeas.so.0(AUGEAS_0.8.0)(64bit) for package: ruby-augeas-0.4.1-3.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: libaugeas.so.0(AUGEAS_0.1.0)(64bit) for package: ruby-augeas-0.4.1-3.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: libaugeas.so.0(AUGEAS_0.12.0)(64bit) for package: ruby-augeas-0.4.1-3.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: libaugeas.so.0(AUGEAS_0.10.0)(64bit) for package: ruby-augeas-0.4.1-3.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: libaugeas.so.0(AUGEAS_0.11.0)(64bit) for package: ruby-augeas-0.4.1-3.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: libaugeas.so.0()(64bit) for package: ruby-augeas-0.4.1-3.el7.x86_64
==&gt; omv1: ---&gt; Package ruby-shadow.x86_64 1:2.2.0-2.el7 will be installed
==&gt; omv1: ---&gt; Package rubygem-json.x86_64 0:1.7.7-24.el7 will be installed
==&gt; omv1: --&gt; Running transaction check
==&gt; omv1: ---&gt; Package augeas-libs.x86_64 0:1.1.0-17.el7 will be installed
==&gt; omv1: ---&gt; Package dmidecode.x86_64 1:2.12-5.el7 will be installed
==&gt; omv1: ---&gt; Package net-tools.x86_64 0:2.0-0.17.20131004git.el7 will be installed
==&gt; omv1: ---&gt; Package pciutils.x86_64 0:3.2.1-4.el7 will be installed
==&gt; omv1: --&gt; Processing Dependency: pciutils-libs = 3.2.1-4.el7 for package: pciutils-3.2.1-4.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: libpci.so.3(LIBPCI_3.2)(64bit) for package: pciutils-3.2.1-4.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: libpci.so.3(LIBPCI_3.1)(64bit) for package: pciutils-3.2.1-4.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: libpci.so.3(LIBPCI_3.0)(64bit) for package: pciutils-3.2.1-4.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: hwdata for package: pciutils-3.2.1-4.el7.x86_64
==&gt; omv1: --&gt; Processing Dependency: libpci.so.3()(64bit) for package: pciutils-3.2.1-4.el7.x86_64
==&gt; omv1: ---&gt; Package ruby-libs.x86_64 0:2.0.0.598-24.el7 will be installed
==&gt; omv1: ---&gt; Package rubygem-bigdecimal.x86_64 0:1.2.0-24.el7 will be installed
==&gt; omv1: ---&gt; Package rubygems.noarch 0:2.0.14-24.el7 will be installed
==&gt; omv1: --&gt; Processing Dependency: rubygem(rdoc) &gt;= 4.0.0 for package: rubygems-2.0.14-24.el7.noarch
==&gt; omv1: --&gt; Processing Dependency: rubygem(psych) &gt;= 2.0.0 for package: rubygems-2.0.14-24.el7.noarch
==&gt; omv1: --&gt; Processing Dependency: rubygem(io-console) &gt;= 0.4.2 for package: rubygems-2.0.14-24.el7.noarch
==&gt; omv1: ---&gt; Package virt-what.x86_64 0:1.13-5.el7 will be installed
==&gt; omv1: --&gt; Running transaction check
==&gt; omv1: ---&gt; Package hwdata.noarch 0:0.252-7.5.el7 will be installed
==&gt; omv1: ---&gt; Package pciutils-libs.x86_64 0:3.2.1-4.el7 will be installed
==&gt; omv1: ---&gt; Package rubygem-io-console.x86_64 0:0.4.2-24.el7 will be installed
==&gt; omv1: ---&gt; Package rubygem-psych.x86_64 0:2.0.0-24.el7 will be installed
==&gt; omv1: --&gt; Processing Dependency: libyaml-0.so.2()(64bit) for package: rubygem-psych-2.0.0-24.el7.x86_64
==&gt; omv1: ---&gt; Package rubygem-rdoc.noarch 0:4.0.0-24.el7 will be installed
==&gt; omv1: --&gt; Processing Dependency: ruby(irb) = 2.0.0.598 for package: rubygem-rdoc-4.0.0-24.el7.noarch
==&gt; omv1: --&gt; Running transaction check
==&gt; omv1: ---&gt; Package libyaml.x86_64 0:0.1.4-11.el7_0 will be installed
==&gt; omv1: ---&gt; Package ruby-irb.noarch 0:2.0.0.598-24.el7 will be installed
==&gt; omv1: --&gt; Finished Dependency Resolution
==&gt; omv1: 
==&gt; omv1: Dependencies Resolved
==&gt; omv1: 
==&gt; omv1: ================================================================================
==&gt; omv1:  Package            Arch   Version                    Repository           Size
==&gt; omv1: ================================================================================
==&gt; omv1: Installing:
==&gt; omv1:  puppet             noarch 3.7.5-1.el7                puppetlabs-products 1.5 M
==&gt; omv1: Installing for dependencies:
==&gt; omv1:  augeas-libs        x86_64 1.1.0-17.el7               base                332 k
==&gt; omv1:  dmidecode          x86_64 1:2.12-5.el7               base                 78 k
==&gt; omv1:  facter             x86_64 1:2.4.3-1.el7              puppetlabs-products  98 k
==&gt; omv1:  hiera              noarch 1.3.4-1.el7                puppetlabs-products  23 k
==&gt; omv1:  hwdata             noarch 0.252-7.5.el7              base                2.0 M
==&gt; omv1:  libselinux-ruby    x86_64 2.2.2-6.el7                base                127 k
==&gt; omv1:  libselinux-utils   x86_64 2.2.2-6.el7                base                135 k
==&gt; omv1:  libyaml            x86_64 0.1.4-11.el7_0             base                 55 k
==&gt; omv1:  net-tools          x86_64 2.0-0.17.20131004git.el7   base                304 k
==&gt; omv1:  pciutils           x86_64 3.2.1-4.el7                base                 90 k
==&gt; omv1:  pciutils-libs      x86_64 3.2.1-4.el7                base                 45 k
==&gt; omv1:  ruby               x86_64 2.0.0.598-24.el7           base                 67 k
==&gt; omv1:  ruby-augeas        x86_64 0.4.1-3.el7                puppetlabs-deps      22 k
==&gt; omv1:  ruby-irb           noarch 2.0.0.598-24.el7           base                 88 k
==&gt; omv1:  ruby-libs          x86_64 2.0.0.598-24.el7           base                2.8 M
==&gt; omv1:  ruby-shadow        x86_64 1:2.2.0-2.el7              puppetlabs-deps      14 k
==&gt; omv1:  rubygem-bigdecimal x86_64 1.2.0-24.el7               base                 79 k
==&gt; omv1:  rubygem-io-console x86_64 0.4.2-24.el7               base                 50 k
==&gt; omv1:  rubygem-json       x86_64 1.7.7-24.el7               base                 75 k
==&gt; omv1:  rubygem-psych      x86_64 2.0.0-24.el7               base                 77 k
==&gt; omv1:  rubygem-rdoc       noarch 4.0.0-24.el7               base                318 k
==&gt; omv1:  rubygems           noarch 2.0.14-24.el7              base                212 k
==&gt; omv1:  virt-what          x86_64 1.13-5.el7                 base                 26 k
==&gt; omv1: 
==&gt; omv1: Transaction Summary
==&gt; omv1: ================================================================================
==&gt; omv1: Install  1 Package (+23 Dependent packages)
==&gt; omv1: 
==&gt; omv1: Total download size: 8.6 M
==&gt; omv1: Installed size: 27 M
==&gt; omv1: Downloading packages:
==&gt; omv1: warning: /var/cache/yum/x86_64/7/puppetlabs-products/packages/hiera-1.3.4-1.el7.noarch.rpm: Header V4 RSA/SHA512 Signature, key ID 4bd6ec30: NOKEY
==&gt; omv1: 
==&gt; omv1: Public key for hiera-1.3.4-1.el7.noarch.rpm is not installed
==&gt; omv1: warning: /var/cache/yum/x86_64/7/base/packages/dmidecode-2.12-5.el7.x86_64.rpm: Header V3 RSA/SHA256 Signature, key ID f4a80eb5: NOKEY
==&gt; omv1: 
==&gt; omv1: Public key for dmidecode-2.12-5.el7.x86_64.rpm is not installed
==&gt; omv1: Public key for ruby-augeas-0.4.1-3.el7.x86_64.rpm is not installed
==&gt; omv1: --------------------------------------------------------------------------------
==&gt; omv1: Total                                              811 kB/s | 8.6 MB  00:10     
==&gt; omv1: Retrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
==&gt; omv1: Importing GPG key 0xF4A80EB5:
==&gt; omv1:  Userid     : &quot;CentOS-7 Key (CentOS 7 Official Signing Key) &lt;security@centos.org&gt;&quot;
==&gt; omv1:  Fingerprint: 6341 ab27 53d7 8a78 a7c2 7bb1 24c6 a8a7 f4a8 0eb5
==&gt; omv1:  Package    : centos-release-7-1.1503.el7.centos.2.8.x86_64 (@CentOS/$releasever)
==&gt; omv1:  From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
==&gt; omv1: 
==&gt; omv1: Retrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-puppetlabs
==&gt; omv1: Importing GPG key 0x4BD6EC30:
==&gt; omv1:  Userid     : &quot;Puppet Labs Release Key (Puppet Labs Release Key) &lt;info@puppetlabs.com&gt;&quot;
==&gt; omv1:  Fingerprint: 47b3 20eb 4c7c 375a a9da e1a0 1054 b7a2 4bd6 ec30
==&gt; omv1:  From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-puppetlabs
==&gt; omv1: 
==&gt; omv1: Running transaction check
==&gt; omv1: Running transaction test
==&gt; omv1: Transaction test succeeded
==&gt; omv1: Running transaction
==&gt; omv1:   Installing : ruby-libs-2.0.0.598-24.el7.x86_64                           1/24
==&gt; omv1:  
==&gt; omv1:   Installing : 1:dmidecode-2.12-5.el7.x86_64                               2/24
==&gt; omv1:  
==&gt; omv1:   Installing : virt-what-1.13-5.el7.x86_64                                 3/24
==&gt; omv1:  
==&gt; omv1:   Installing : libyaml-0.1.4-11.el7_0.x86_64                               4/24
==&gt; omv1:  
==&gt; omv1:   Installing : rubygem-psych-2.0.0-24.el7.x86_64                           5/24
==&gt; omv1:  
==&gt; omv1:   Installing : rubygem-bigdecimal-1.2.0-24.el7.x86_64                      6/24
==&gt; omv1:  
==&gt; omv1:   Installing : rubygem-io-console-0.4.2-24.el7.x86_64                      7/24
==&gt; omv1:  
==&gt; omv1:   Installing : ruby-irb-2.0.0.598-24.el7.noarch                            8/24
==&gt; omv1:  
==&gt; omv1:   Installing : ruby-2.0.0.598-24.el7.x86_64                                9/24
==&gt; omv1:  
==&gt; omv1:   Installing : rubygems-2.0.14-24.el7.noarch                              10/24
==&gt; omv1:  
==&gt; omv1:   Installing : rubygem-json-1.7.7-24.el7.x86_64                           11/24
==&gt; omv1:  
==&gt; omv1:   Installing : rubygem-rdoc-4.0.0-24.el7.noarch                           12/24
==&gt; omv1:  
==&gt; omv1:   Installing : hiera-1.3.4-1.el7.noarch                                   13/24
==&gt; omv1:  
==&gt; omv1:   Installing : 1:ruby-shadow-2.2.0-2.el7.x86_64                           14/24
==&gt; omv1:  
==&gt; omv1:   Installing : hwdata-0.252-7.5.el7.noarch                                15/24
==&gt; omv1:  
==&gt; omv1:   Installing : libselinux-utils-2.2.2-6.el7.x86_64                        16/24
==&gt; omv1:  
==&gt; omv1:   Installing : pciutils-libs-3.2.1-4.el7.x86_64                           17/24
==&gt; omv1:  
==&gt; omv1:   Installing : pciutils-3.2.1-4.el7.x86_64                                18/24
==&gt; omv1:  
==&gt; omv1:   Installing : augeas-libs-1.1.0-17.el7.x86_64                            19/24
==&gt; omv1:  
==&gt; omv1:   Installing : ruby-augeas-0.4.1-3.el7.x86_64                             20/24
==&gt; omv1:  
==&gt; omv1:   Installing : net-tools-2.0-0.17.20131004git.el7.x86_64                  21/24
==&gt; omv1:  
==&gt; omv1:   Installing : 1:facter-2.4.3-1.el7.x86_64                                22/24
==&gt; omv1:  
==&gt; omv1:   Installing : libselinux-ruby-2.2.2-6.el7.x86_64                         23/24
==&gt; omv1:  
==&gt; omv1:   Installing : puppet-3.7.5-1.el7.noarch                                  24/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : libselinux-ruby-2.2.2-6.el7.x86_64                          1/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : rubygem-json-1.7.7-24.el7.x86_64                            2/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : ruby-irb-2.0.0.598-24.el7.noarch                            3/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : ruby-libs-2.0.0.598-24.el7.x86_64                           4/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : net-tools-2.0-0.17.20131004git.el7.x86_64                   5/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : augeas-libs-1.1.0-17.el7.x86_64                             6/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : pciutils-libs-3.2.1-4.el7.x86_64                            7/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : rubygem-psych-2.0.0-24.el7.x86_64                           8/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : 1:facter-2.4.3-1.el7.x86_64                                 9/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : pciutils-3.2.1-4.el7.x86_64                                10/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : puppet-3.7.5-1.el7.noarch                                  11/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : hiera-1.3.4-1.el7.noarch                                   12/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : rubygem-rdoc-4.0.0-24.el7.noarch                           13/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : virt-what-1.13-5.el7.x86_64                                14/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : rubygems-2.0.14-24.el7.noarch                              15/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : libselinux-utils-2.2.2-6.el7.x86_64                        16/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : 1:ruby-shadow-2.2.0-2.el7.x86_64                           17/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : rubygem-bigdecimal-1.2.0-24.el7.x86_64                     18/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : 1:dmidecode-2.12-5.el7.x86_64                              19/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : hwdata-0.252-7.5.el7.noarch                                20/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : libyaml-0.1.4-11.el7_0.x86_64                              21/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : rubygem-io-console-0.4.2-24.el7.x86_64                     22/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : ruby-augeas-0.4.1-3.el7.x86_64                             23/24
==&gt; omv1:  
==&gt; omv1:   Verifying  : ruby-2.0.0.598-24.el7.x86_64                               24/24
==&gt; omv1:  
==&gt; omv1: 
==&gt; omv1: Installed:
==&gt; omv1:   puppet.noarch 0:3.7.5-1.el7                                                   
==&gt; omv1: 
==&gt; omv1: Dependency Installed:
==&gt; omv1:   augeas-libs.x86_64 0:1.1.0-17.el7                                             
==&gt; omv1:   dmidecode.x86_64 1:2.12-5.el7                                                 
==&gt; omv1:   facter.x86_64 1:2.4.3-1.el7                                                   
==&gt; omv1:   hiera.noarch 0:1.3.4-1.el7                                                    
==&gt; omv1:   hwdata.noarch 0:0.252-7.5.el7                                                 
==&gt; omv1:   libselinux-ruby.x86_64 0:2.2.2-6.el7                                          
==&gt; omv1:   libselinux-utils.x86_64 0:2.2.2-6.el7                                         
==&gt; omv1:   libyaml.x86_64 0:0.1.4-11.el7_0                                               
==&gt; omv1:   net-tools.x86_64 0:2.0-0.17.20131004git.el7                                   
==&gt; omv1:   pciutils.x86_64 0:3.2.1-4.el7                                                 
==&gt; omv1:   pciutils-libs.x86_64 0:3.2.1-4.el7                                            
==&gt; omv1:   ruby.x86_64 0:2.0.0.598-24.el7                                                
==&gt; omv1:   ruby-augeas.x86_64 0:0.4.1-3.el7                                              
==&gt; omv1:   ruby-irb.noarch 0:2.0.0.598-24.el7                                            
==&gt; omv1:   ruby-libs.x86_64 0:2.0.0.598-24.el7                                           
==&gt; omv1:   ruby-shadow.x86_64 1:2.2.0-2.el7                                              
==&gt; omv1:   rubygem-bigdecimal.x86_64 0:1.2.0-24.el7                                      
==&gt; omv1:   rubygem-io-console.x86_64 0:0.4.2-24.el7                                      
==&gt; omv1:   rubygem-json.x86_64 0:1.7.7-24.el7                                            
==&gt; omv1:   rubygem-psych.x86_64 0:2.0.0-24.el7                                           
==&gt; omv1:   rubygem-rdoc.noarch 0:4.0.0-24.el7                                            
==&gt; omv1:   rubygems.noarch 0:2.0.14-24.el7                                               
==&gt; omv1:   virt-what.x86_64 0:1.13-5.el7                                                 
==&gt; omv1: Complete!
==&gt; omv1:  ---&gt; bf169104271a
==&gt; omv1: Removing intermediate container e44c9cf55dc5
==&gt; omv1: Step 6 : RUN yum install -y hostname
==&gt; omv1:  ---&gt; Running in 6e5bd5a59223
==&gt; omv1: Loaded plugins: fastestmirror
==&gt; omv1: Loading mirror speeds from cached hostfile
==&gt; omv1:  * base: centos.mirror.vexxhost.com
==&gt; omv1:  * extras: mirror.gpmidi.net
==&gt; omv1:  * updates: centos.mirror.vexxhost.com
==&gt; omv1: Resolving Dependencies
==&gt; omv1: --&gt; Running transaction check
==&gt; omv1: ---&gt; Package hostname.x86_64 0:3.13-3.el7 will be installed
==&gt; omv1: --&gt; Finished Dependency Resolution
==&gt; omv1: 
==&gt; omv1: Dependencies Resolved
==&gt; omv1: 
==&gt; omv1: ================================================================================
==&gt; omv1:  Package            Arch             Version               Repository      Size
==&gt; omv1: ================================================================================
==&gt; omv1: Installing:
==&gt; omv1:  hostname           x86_64           3.13-3.el7            base            17 k
==&gt; omv1: 
==&gt; omv1: Transaction Summary
==&gt; omv1: ================================================================================
==&gt; omv1: Install  1 Package
==&gt; omv1: 
==&gt; omv1: Total download size: 17 k
==&gt; omv1: Installed size: 19 k
==&gt; omv1: Downloading packages:
==&gt; omv1: Running transaction check
==&gt; omv1: Running transaction test
==&gt; omv1: Transaction test succeeded
==&gt; omv1: Running transaction
==&gt; omv1:   Installing : hostname-3.13-3.el7.x86_64                                   1/1
==&gt; omv1:  
==&gt; omv1:   Verifying  : hostname-3.13-3.el7.x86_64                                   1/1
==&gt; omv1:  
==&gt; omv1: 
==&gt; omv1: Installed:
==&gt; omv1:   hostname.x86_64 0:3.13-3.el7                                                  
==&gt; omv1: 
==&gt; omv1: Complete!
==&gt; omv1:  ---&gt; 2a20361f2d9d
==&gt; omv1: Removing intermediate container 6e5bd5a59223
==&gt; omv1: Step 7 : ADD run.sh /
==&gt; omv1:  ---&gt; 5493e62ac377
==&gt; omv1: Removing intermediate container 84c8b7677f72
==&gt; omv1: Step 8 : ADD test.pp /
==&gt; omv1:  ---&gt; 4f4d0023e612
==&gt; omv1: Removing intermediate container 84cb691304a3
==&gt; omv1: Step 9 : ENV FACTER_fqdn localhost
==&gt; omv1:  ---&gt; Running in 104fe3925dd6
==&gt; omv1:  ---&gt; 864c113d54b5
==&gt; omv1: Removing intermediate container 104fe3925dd6
==&gt; omv1: Step 10 : ENTRYPOINT puppet apply
==&gt; omv1:  ---&gt; Running in f6fe26141b19
==&gt; omv1:  ---&gt; cd19e4344bf1
==&gt; omv1: Removing intermediate container f6fe26141b19
==&gt; omv1: Step 11 : USER root
==&gt; omv1:  ---&gt; Running in 435752b9fb17
==&gt; omv1:  ---&gt; 86193e9815a8
==&gt; omv1: Removing intermediate container 435752b9fb17
==&gt; omv1: Step 12 : LABEL INSTALL docker run --rm -it --privileged -v /etc:/etc -v /var:/var -v /run:/run --net=host IMAGE
==&gt; omv1:  ---&gt; Running in d24f98a56936
==&gt; omv1:  ---&gt; 72f2dfbc4e07
==&gt; omv1: Removing intermediate container d24f98a56936
==&gt; omv1: Successfully built 72f2dfbc4e07

real    2m46.515s
user    0m10.036s
sys    0m1.678s
</code></pre>

<p>Once you&rsquo;ve built the container, you should confirm its existence:</p>

<pre><code>$ vscreen root@omv1
# docker images | grep spc
spc-puppet-apply    latest              72f2dfbc4e07        7 minutes ago       314.5 MB
</code></pre>

<p>The project repository tries to make your life easier, so it comes with a <code>test.pp</code> file that you can run to confirm puppet is working correctly. If you are using a regular host (not Atomic) you can run:</p>

<pre><code># mkdir /var/tmp/spc-puppet-apply/
# cp -a /vagrant/docker/spc-puppet-apply/test.pp /var/tmp/spc-puppet-apply/
</code></pre>

<p>or if you&rsquo;re using an Atomic host, you can run:</p>

<pre><code># mkdir /var/tmp/spc-puppet-apply/
# cp -a /home/vagrant/sync/docker/spc-puppet-apply/test.pp /var/tmp/spc-puppet-apply/
</code></pre>

<p>since Oh-My-Vagrant can&rsquo;t put files in <code>/vagrant</code> on an immutable Atomic host.</p>

<p>Finally, run the application with this monster docker command:</p>

<pre><code># docker run --rm -it --privileged -v /etc:/etc -v /var:/var -v /run:/run --net=host spc-puppet-apply /var/tmp/spc-puppet-apply/test.pp
Notice: Compiled catalog for omv1.example.com in environment production in 0.02 seconds
Notice: This is a puppet test!

Notice: /Stage[main]/Main/Notify[hello]/message: defined 'message' as 'This is a puppet test!'
Notice: Finished catalog run in 0.06 seconds
</code></pre>

<p>Since remembering that monster each time you want to do a simple puppet run is a bit of a monster, the Atomic project provides labels which make it so you can use the <code>atomic run</code> command instead.</p>

<p><span style="text-decoration:underline;">Future work</span>:</p>

<p>Interested parties are encouraged to test this, find any issues, and become comfortable with the idea of applications running from within containers. If running puppet with a puppet master is desirable, an <code>spc-puppet-agent</code> would be needed.</p>

<p>Happy Hacking,</p>

<p>James</p>

			</div>
		</div>

		
		<div class="col-md-3">
			<div class="well well-sm"> 
				<h4>June 12, 2015<br>
				<small>2738 words</small></h4>
				<hr>
				<strong>Categories</strong>
				<ul class="list-unstyled">
				
					<li><a href="/categories/technical">technical</a></li>
				
				</ul>
				<hr>
				<strong>Tags</strong><br>
				<a class="label label-default" href="/tags/atomic">atomic</a> <a class="label label-default" href="/tags/devops">devops</a> <a class="label label-default" href="/tags/dnf">dnf</a> <a class="label label-default" href="/tags/docker">docker</a> <a class="label label-default" href="/tags/facter">facter</a> <a class="label label-default" href="/tags/fedora">fedora</a> <a class="label label-default" href="/tags/oh-my-vagrant">oh-my-vagrant</a> <a class="label label-default" href="/tags/omv">omv</a> <a class="label label-default" href="/tags/planetdevops">planetdevops</a> <a class="label label-default" href="/tags/planetfedora">planetfedora</a> <a class="label label-default" href="/tags/planetpuppet">planetpuppet</a> <a class="label label-default" href="/tags/puppet">puppet</a> <a class="label label-default" href="/tags/spc">spc</a> <a class="label label-default" href="/tags/spc-puppet-apply">spc-puppet-apply</a> <a class="label label-default" href="/tags/vagrant">vagrant</a> <a class="label label-default" href="/tags/vscreen">vscreen</a> <a class="label label-default" href="/tags/yum">yum</a> 
				
				<hr>
				<strong>Original URL</strong><br>
				<a href="https://ttboj.wordpress.com/2015/06/12/a-super-privileged-puppet-container/"><small>https://ttboj.wordpress.com/2015/06/12/a-super-privileged-puppet-container/</small></a>
				

				
			</div>
				<div class="panel panel-default">
		<div class="panel-heading" style="padding: 2px 15px;">
			<h4>Oh hello...</h4>
		</div>
		<div class="panel-body">

			<a href="https://twitter.com/purpleidea" class="btn btn-info btn-xs"><i class="fa fa-twitter-square fa-2x"></i></a>


			<a href="https://github.com/purpleidea/" class="btn btn-primary btn-xs"><i class="fa fa-github-square fa-2x"></i></a>



			<div class="alert alert-info alert-dismissable" style="margin-top:25px;margin-bottom:5px;">
				<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
				<strong>Hey, hacker!</strong><br>
				You should follow me to get new updates!
			</div>
		</div>
	</div>

		</div>
	</div>

	<div class="row">
		<hr>

	<a name="comments"></a>
<section class="post-comments">
	<h3>Comments</h3>






	


	<p>Nothing yet.</p>

	<hr />
	<a name="comment"></a>
	<h3>Post a comment</h3>
	<form class="post-new-comment" method="POST" action="https://api.staticman.net/v2/entry/purpleidea/purpleidea.com/master/comments">
		<input type="hidden" name="options[redirect]" value="https://purpleidea.com/blog/2015/06/12/a-super-privileged-puppet-container/#comment-submitted">
		<input type="hidden" name="options[entryId]" value="blog/2015/06/12/a-super-privileged-puppet-container">
		<div class="col-md-9">
			<div class="row">
				<textarea name="fields[message]" style="width: 80%; height: 50px;" class="post-comment-field" placeholder="Please enter your comment here..." rows="10"></textarea><br />
			</div>
			<div class="row">
				<input name="fields[name]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your name">
			</div>
			<div class="row">
				<input name="fields[email]" type="email" style="width: 50%;" class="post-comment-field" placeholder="Your email address">
			</div>
			<div class="row">
				<input name="fields[url]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your website">
			</div>
			<div class="row">
				<input type="submit" style="width: 80%;" class="post-comment-field btn btn-primary btn-xs" value="Submit">
			</div>
		</div>
	</form>
</section>

<div id="comment-submitted" class="dialog">
	<hr />
	<h3>Thank you</h3>
	<p>Your comment has been submitted and will be published if it gets approved.</p>
	<p><a href="https://github.com/purpleidea/purpleidea.com/pulls">Click here</a> to see the patch you generated.</p>
	<p><a href="#" class="btn">OK</a></p>
</div>

	</div>
		<footer>
		<div class="row">
			<hr>
			<div class="col-sm-12">
				<p>
				&copy; James Shubin 2018 &middot;
				<a href="https://purpleidea.com/">https://purpleidea.com/</a> &middot;
				<a href="https://github.com/purpleidea/purpleidea.com/blob/master/content/blog/2015/06/12/a-super-privileged-puppet-container.md" style="color:grey">Edit this page</a>
				</p>
			</div>
		</div>
		</footer>
	</div>

	<script src="/js/jquery-1.11.3.min.js"></script>
	<script src="/js/bootstrap.js"></script>
</body>
</html>

