<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="James Shubin">

	<title>Introducing: Silent counter - https://purpleidea.com/</title>
	<link rel="canonical" href="https://purpleidea.com/blog/2015/02/09/introducing-silent-counter/">

	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/font-awesome.css" rel="stylesheet">
	<link href="/css/custom.css" rel="stylesheet">
	<link href="/css/staticman.css" rel="stylesheet">

	
</head>
<body>
	<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
					<span class="sr-only">Toggle Navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="https://purpleidea.com/">purpleidea.com</a>
			</div>
			<div class="collapse navbar-collapse navbar-ex1-collapse">
				<ul class="nav navbar-nav">

					<li><a href="/about/">about</a></li>
					<li><a href="/blog/">blog</a></li>
					<li><a href="/contact/">contact</a></li>
					<li><a href="/misc/">misc</a></li>
					<li><a href="/talks/">talks</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container">

	<div class="row">
		<div class="col-md-9">
			<div class="well well-sm">
					<h3><strong>Introducing: Silent counter</strong><br><small></small></h3>
					<hr>
					<p>You might want to write code that can tell how many iterations have passed since some action occurred. Alternatively, you might want to know if it&rsquo;s the first time a machine has run <a href="https://en.wikipedia.org/wiki/Puppet_%28software%29">Puppet</a>. To do these types of things, you might wish to have a <a href="https://en.wikipedia.org/wiki/Monotonic_function">monotonically</a> increasing counter in your Puppet manifest. Since one did not exist, I set out to build one!</p>

<p><span style="text-decoration:underline;">The code</span>:</p>

<p>If you just want to try the code, and skip the ramble, you can include <a href="https://github.com/purpleidea/puppet-common/blob/master/manifests/counter.pp#L18">common::counter</a> into your manifest. The entire class is part of my puppet-common module:</p>

<pre><code>git clone https://github.com/purpleidea/puppet-common
</code></pre>

<p><span style="text-decoration:underline;">Usage</span>:</p>

<p>Usage notes are hardly even necessary. Here is how the code is commonly used:</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">include</span> <span style="color:#f92672">::</span>common<span style="color:#f92672">::</span>counter    <span style="color:#75715e"># that&#39;s it!</span>

<span style="color:#75715e"># NOTE: we only see the notify message. no other exec/change is shown!</span>
notify { <span style="color:#e6db74">&#39;counter&#39;</span>:
        message <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Value is: ${::common_counter_simple}&#34;</span>,
}</code></pre></div>
Now use the fact anywhere you need a counter!</p>

<p><span style="text-decoration:underline;">Increasing a variable</span>:</p>

<p>At the heart of any counter, you&rsquo;ll need to have a value store, a way to read the value, and a way to increment the value. For simplicity, the value store we&rsquo;ll use will be a file on disk. This file is located by default at <code>${vardir}/common/counter/simple</code>. To read the value, we use a puppet fact. The fact has a key name of <code>$::common_counter_simple</code>. To increment the value, a simple python script is used.</p>

<p><span style="text-decoration:underline;">Noise</span>:</p>

<p>To cause an increment of the value on each puppet run, an <a href="https://docs.puppetlabs.com/references/stable/type.html#exec">exec</a> would have to be used. The downside of this is that this causes noise in your puppet logs, even if nothing else is happening! This noise is unwanted, so we work around this with the following code:</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">exec { <span style="color:#e6db74">&#39;counter&#39;</span>:
        <span style="color:#75715e"># echo an error message and be false, if the incrementing fails</span>
        command <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;/bin/echo &#34;common::counter failed&#34; &amp;&amp; /bin/false&#39;</span>,
        <span style="color:#66d9ef">unless</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;${vardir}/counter/increment.py &#39;${vardir}/counter/simple&#39;&#34;</span>,
        logoutput <span style="color:#f92672">=&gt;</span> on_failure,
}</code></pre></div>
As you can see, we cause the run to happen in the silent &ldquo;unless&rdquo; part of the exec, and we don&rsquo;t actually allow any exec to occur unless there is an error running the <em>increment.py</em>!</p>

<p><span style="text-decoration:underline;">Complex example</span>:</p>

<p>If you want to do something more complicated using this technique, you might want to write something like this:</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">$max <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
exec { <span style="color:#e6db74">&#34;/bin/echo this is run #: ${::common_counter_simple}&#34;</span>:
        logoutput <span style="color:#f92672">=&gt;</span> on_failure,
        onlyif <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span>
                <span style="color:#e6db74">&#34;/usr/bin/test ${::common_counter_simple} -lt ${max}&#34;</span>,
                <span style="color:#e6db74">&#34;/usr/bin/test ${::common_counter_simple} -gt 0&#34;</span>,
        <span style="color:#f92672">]</span>,
    <span style="color:#75715e">#notify =&gt; ...,    # do some action</span>
}</code></pre></div>
<span style="text-decoration:underline;">Side effects</span>:</p>

<p>Make sure not to use the counter fact in a <em>$name</em> or somewhere that would cause frequent unwanted catalog changes, as it could cause a lot of changes each run.</p>

<p><span style="text-decoration:underline;">Module pairings</span>:</p>

<p>You might want to pair this module with my &ldquo;<a href="/blog/2013/09/28/finite-state-machines-in-puppet/">Finite State Machine</a>&rdquo; concept, or my <a href="/blog/2014/03/24/introducing-puppet-execagain/">Exec[&lsquo;again&rsquo;]</a> module. If you come up with some cool use cases, please <a href="/contact/">let me know</a>!</p>

<p><span style="text-decoration:underline;">Future work</span>:</p>

<p>If you&rsquo;d like to extend this work, two features come to mind:
<ol>
    <li>Individual named counters. If for some reason you want more than one counter, named counters could be built.</li>
    <li>Reset functionality. If you&rsquo;d like to reset a counter to zero (or to some other value) then there should be a special type you could create which causes this to happen.</li>
</ol>
If you&rsquo;d like to work on either of these features, please let me know, or send me a patch!</p>

<p>Happy hacking!</p>

<p>James</p>

			</div>
		</div>

		
		<div class="col-md-3">
			<div class="well well-sm"> 
				<h4>February 9, 2015<br>
				<small>545 words</small></h4>
				<hr>
				<strong>Categories</strong>
				<ul class="list-unstyled">
				
					<li><a href="/categories/technical">technical</a></li>
				
				</ul>
				<hr>
				<strong>Tags</strong><br>
				<a class="label label-default" href="/tags/counter">counter</a> <a class="label label-default" href="/tags/gluster">gluster</a> <a class="label label-default" href="/tags/monotonic">monotonic</a> <a class="label label-default" href="/tags/planetdevops">planetdevops</a> <a class="label label-default" href="/tags/planetfedora">planetfedora</a> <a class="label label-default" href="/tags/planetpuppet">planetpuppet</a> <a class="label label-default" href="/tags/puppet">puppet</a> <a class="label label-default" href="/tags/python">python</a> <a class="label label-default" href="/tags/silent-counter">silent counter</a> 
				
				<hr>
				<strong>Original URL</strong><br>
				<a href="https://ttboj.wordpress.com/2015/02/09/introducing-silent-counter/"><small>https://ttboj.wordpress.com/2015/02/09/introducing-silent-counter/</small></a>
				

				
			</div>
				<div class="panel panel-default">
		<div class="panel-heading" style="padding: 2px 15px;">
			<h4>Oh hello...</h4>
		</div>
		<div class="panel-body">

			<a href="https://twitter.com/purpleidea" class="btn btn-info btn-xs"><i class="fa fa-twitter-square fa-2x"></i></a>


			<a href="https://github.com/purpleidea/" class="btn btn-primary btn-xs"><i class="fa fa-github-square fa-2x"></i></a>



			<div class="alert alert-info alert-dismissable" style="margin-top:25px;margin-bottom:5px;">
				<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
				<strong>Hey, hacker!</strong><br>
				You should follow me to get new updates!
			</div>
		</div>
	</div>

		</div>
	</div>

	<div class="row">
		<hr>

	<a name="comments"></a>
<section class="post-comments">
	<h3>Comments</h3>






	

	


	<p>Nothing yet.</p>

	<hr />
	<a name="comment"></a>
	<h3>Post a comment</h3>
	<form class="post-new-comment" method="POST" action="https://api.staticman.net/v2/entry/purpleidea/purpleidea.com/master/comments">
		<input type="hidden" name="options[redirect]" value="https://purpleidea.com/blog/2015/02/09/introducing-silent-counter/#comment-submitted">
		<input type="hidden" name="options[entryId]" value="blog/2015/02/09/introducing-silent-counter">
		<div class="col-md-9">
			<div class="row">
				<textarea name="fields[message]" style="width: 80%; height: 50px;" class="post-comment-field" placeholder="Please enter your comment here..." rows="10"></textarea><br />
			</div>
			<div class="row">
				<input name="fields[name]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your name">
			</div>
			<div class="row">
				<input name="fields[email]" type="email" style="width: 50%;" class="post-comment-field" placeholder="Your email address">
			</div>
			<div class="row">
				<input name="fields[url]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your website">
			</div>
			<div class="row">
				<input type="submit" style="width: 80%;" class="post-comment-field btn btn-primary btn-xs" value="Submit">
			</div>
		</div>
	</form>
</section>

<div id="comment-submitted" class="dialog">
	<hr />
	<h3>Thank you</h3>
	<p>Your comment has been submitted and will be published if it gets approved.</p>
	<p><a href="https://github.com/purpleidea/purpleidea.com/pulls">Click here</a> to see the patch you generated.</p>
	<p><a href="#" class="btn">OK</a></p>
</div>

	</div>
		<footer>
		<div class="row">
			<hr>
			<div class="col-sm-12">
				<p>
				&copy; James Shubin 2018 &middot;
				<a href="https://purpleidea.com/">https://purpleidea.com/</a> &middot;
				<a href="https://github.com/purpleidea/purpleidea.com/blob/master/content/blog/2015/02/09/introducing-silent-counter.md" style="color:grey">Edit this page</a>
				</p>
			</div>
		</div>
		</footer>
	</div>

	<script src="/js/jquery-1.11.3.min.js"></script>
	<script src="/js/bootstrap.js"></script>
</body>
</html>

