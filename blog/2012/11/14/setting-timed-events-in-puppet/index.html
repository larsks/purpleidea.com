<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="James Shubin">

	<title>setting timed events in puppet - https://purpleidea.com/</title>
	<link rel="canonical" href="https://purpleidea.com/blog/2012/11/14/setting-timed-events-in-puppet/">

	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/font-awesome.css" rel="stylesheet">
	<link href="/css/custom.css" rel="stylesheet">
	<link href="/css/staticman.css" rel="stylesheet">

	
</head>
<body>
	<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
					<span class="sr-only">Toggle Navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="https://purpleidea.com/">purpleidea.com</a>
			</div>
			<div class="collapse navbar-collapse navbar-ex1-collapse">
				<ul class="nav navbar-nav">

					<li><a href="/about/">about</a></li>
					<li><a href="/blog/">blog</a></li>
					<li><a href="/contact/">contact</a></li>
					<li><a href="/misc/">misc</a></li>
					<li><a href="/talks/">talks</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container">

	<div class="row">
		<div class="col-md-9">
			<div class="well well-sm">
					<h3><strong>setting timed events in puppet</strong><br><small></small></h3>
					<hr>
					<p>I&rsquo;ve tried to push puppet to its limits, and so far I&rsquo;ve succeeded. When you hit <a href="http://projects.puppetlabs.com/issues/1565">the kind of bug that forces you to hack around it</a>, you know you are close. In any case, this isn&rsquo;t about that embarrassing bug, it&rsquo;s about how to set delayed actions in puppet.</p>

<p>Enter puppet-runonce, a module that I&rsquo;ve just finished writing. It starts off with the realization that you can exec an action which also writes to a file. If it sees this file, then it knows that it has already completed, and shouldn&rsquo;t run itself again. The relevant parts are here:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">define runonce<span style="color:#f92672">::</span>exec(
    $command <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/bin/true&#39;</span>,
    $notify <span style="color:#f92672">=</span> <span style="color:#66d9ef">undef</span>,
    $repeat_on_failure <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
) {
    <span style="color:#66d9ef">include</span> runonce<span style="color:#f92672">::</span>exec<span style="color:#f92672">::</span>base

    $date <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/bin/date &gt;&gt; /var/lib/puppet/tmp/runonce/exec/${name}&#34;</span>
    $valid_command <span style="color:#f92672">=</span> $repeat_on_failure ? {
        <span style="color:#66d9ef">false</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;${date} &amp;&amp; ${command}&#34;</span>,
        default <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;${command} &amp;&amp; ${date}&#34;</span>,
    }

    exec { <span style="color:#e6db74">&#34;runonce-exec-${name}&#34;</span>:
        command <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;${valid_command}&#34;</span>,
        creates <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;/var/lib/puppet/tmp/runonce/exec/${name}&#34;</span>,    <span style="color:#75715e"># run once</span>
        notify <span style="color:#f92672">=&gt;</span> $notify,
        <span style="color:#75715e"># TODO: add any other parameters here that users wants such as cwd and environment...</span>
        require <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">File</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;/var/lib/puppet/tmp/runonce/exec/&#39;</span><span style="color:#f92672">]</span>,
    }
}</code></pre></div></p>

<p>This depends on having an isolated namespace per module. I need this in many of my modules, and I have chosen: &ldquo;<em>/var/lib/puppet/tmp/$modulename</em>&rdquo;. I&rsquo;ve added the extra feature that this object can repeatedly run until the <em>$command</em> succeeds or it can run once, and ignore the exit status.</p>

<p>Building a timer is slightly trickier, but follows from the first concept. First create a runonce object which when used, creates a file with a timestamp of &ldquo;now&rdquo;. Next, create a new exec object which periodically checks the time, and once we&rsquo;re past a certain delta, exec the desired command. That looks something like this:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># when this is first run by puppet, a &#34;timestamp&#34; matching the system clock is</span>
<span style="color:#75715e"># saved. every time puppet runs (usually every 30 minutes) it compares the</span>
<span style="color:#75715e"># timestamp to the current time, and if this difference exceeds that of the</span>
<span style="color:#75715e"># set delta, then the requested command is executed.</span>
define runonce<span style="color:#f92672">::</span>timer(
    $command <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/bin/true&#39;</span>,
    $delta <span style="color:#f92672">=</span> <span style="color:#ae81ff">3600</span><span style="color:#f92672"></span>,                <span style="color:#75715e"># seconds to wait...</span>
    $notify <span style="color:#f92672">=</span> <span style="color:#66d9ef">undef</span>,
    $repeat_on_failure <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
) {
    <span style="color:#66d9ef">include</span> runonce<span style="color:#f92672">::</span>timer<span style="color:#f92672">::</span>base

    <span style="color:#75715e"># start the timer...</span>
    exec { <span style="color:#e6db74">&#34;/bin/date &gt; /var/lib/puppet/tmp/runonce/start/${name}&#34;</span>:
        creates <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;/var/lib/puppet/tmp/runonce/start/${name}&#34;</span>,    <span style="color:#75715e"># run once</span>
        notify <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">Exec</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#34;runonce-timer-${name}&#34;</span><span style="color:#f92672">]</span>,
        require <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">File</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;/var/lib/puppet/tmp/runonce/start/&#39;</span><span style="color:#f92672">]</span>,
        <span style="color:#66d9ef">alias</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;runonce-start-${name}&#34;</span>,
    }

    $date <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/bin/date &gt;&gt; /var/lib/puppet/tmp/runonce/timer/${name}&#34;</span>
    $valid_command <span style="color:#f92672">=</span> $repeat_on_failure ? {
        <span style="color:#66d9ef">false</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;${date} &amp;&amp; ${command}&#34;</span>,
        default <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;${command} &amp;&amp; ${date}&#34;</span>,
    }

    <span style="color:#75715e"># end the timer and run command (or vice-versa)</span>
    exec { <span style="color:#e6db74">&#34;runonce-timer-${name}&#34;</span>:
        command <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;${valid_command}&#34;</span>,
        creates <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;/var/lib/puppet/tmp/runonce/timer/${name}&#34;</span>,    <span style="color:#75715e"># run once</span>
        <span style="color:#75715e"># NOTE: run if the difference between the current date and the</span>
        <span style="color:#75715e"># saved date (both converted to sec) is greater than the delta</span>
        onlyif <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;/usr/bin/test -e /var/lib/puppet/tmp/runonce/start/${name} &amp;&amp; /usr/bin/test \$(( `/bin/date +%s` - `/usr/bin/head -n 1 /var/lib/puppet/tmp/runonce/start/${name} | /bin/date --file=- +%s` )) -gt ${delta}&#34;</span>,
        notify <span style="color:#f92672">=&gt;</span> $notify,
        require <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span>
            <span style="color:#66d9ef">File</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;/var/lib/puppet/tmp/runonce/timer/&#39;</span><span style="color:#f92672">]</span>,
            <span style="color:#66d9ef">Exec</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#34;runonce-start-${name}&#34;</span><span style="color:#f92672">]</span>,
        <span style="color:#f92672">]</span>,
        <span style="color:#75715e"># TODO: add any other parameters here that users wants such as cwd and environment...</span>
    }
}</code></pre></div></p>

<p>The real &ldquo;magic&rdquo; is in the power of bash, and its individual elegant pieces. The <code>&lt;em&gt;date&lt;/em&gt;</code> command makes it easy to import a previous stored value with <em>&ndash;file</em>, and a bit of conversion glue and mathematics gives us:
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/usr/bin/test -e <span style="color:#e6db74">${</span>startdatefile<span style="color:#e6db74">}</span> <span style="color:#f92672">&amp;&amp;</span> /usr/bin/test <span style="color:#66d9ef">$((</span> <span style="color:#e6db74">`</span>/bin/date +%s<span style="color:#e6db74">`</span> <span style="color:#f92672">-</span> <span style="color:#e6db74">`</span>/usr/bin/head -n <span style="color:#ae81ff">1</span> <span style="color:#e6db74">${</span>startdatefile<span style="color:#e6db74">}</span> | /bin/date --file<span style="color:#f92672">=</span>- +%s<span style="color:#e6db74">`</span> <span style="color:#66d9ef">))</span> -gt <span style="color:#e6db74">${</span>deltaseconds<span style="color:#e6db74">}</span></code></pre></div>
It&rsquo;s a big mouthful to digest on one line, however it&rsquo;s probably write only code anyways, and isn&rsquo;t really that complicated anyhow. One downside is that this is only evaluated every time puppet runs, so in other words it has the approximate granularity of 30 minutes. If you&rsquo;re using this for anything precise, then you&rsquo;re insane!</p>

<p>Speaking of sanity, why would anyone want such a thing? My use case is simple: I&rsquo;m writing a <em>fancy</em> puppet-drbd module, to help me auto-deploy clusters. I always have to manually turn up the initial sync rate to get my cluster happy, but this should be reverted for normal use. The solution is to set an initial sync rate with <em>runonce::exec</em>, and revert it 24 hours later with <em>runonce::timer</em>!</p>

<p>Both this module and my drbd module will be released in the near future. All of this code is <a href="http://www.gnu.org/licenses/agpl-3.0.html">AGPLv3+</a> so please share and enjoy with those freedoms.</p>

<p>Happy hacking,
James</p>

			</div>
		</div>

		
		<div class="col-md-3">
			<div class="well well-sm"> 
				<h4>November 14, 2012<br>
				<small>699 words</small></h4>
				<hr>
				<strong>Categories</strong>
				<ul class="list-unstyled">
				
					<li><a href="/categories/technical">technical</a></li>
				
				</ul>
				<hr>
				<strong>Tags</strong><br>
				<a class="label label-default" href="/tags/agpl">agpl</a> <a class="label label-default" href="/tags/agplv3&#43;">agplv3&#43;</a> <a class="label label-default" href="/tags/devops">devops</a> <a class="label label-default" href="/tags/idempotent">idempotent</a> <a class="label label-default" href="/tags/puppet">puppet</a> <a class="label label-default" href="/tags/run-once">run once</a> <a class="label label-default" href="/tags/timers">timers</a> 
				
				<hr>
				<strong>Original URL</strong><br>
				<a href="https://ttboj.wordpress.com/2012/11/14/setting-timed-events-in-puppet/"><small>https://ttboj.wordpress.com/2012/11/14/setting-timed-events-in-puppet/</small></a>
				

				
			</div>
				<div class="panel panel-default">
		<div class="panel-heading" style="padding: 2px 15px;">
			<h4>Oh hello...</h4>
		</div>
		<div class="panel-body">

			<a href="https://twitter.com/purpleidea" class="btn btn-info btn-xs"><i class="fa fa-twitter-square fa-2x"></i></a>


			<a href="https://github.com/purpleidea/" class="btn btn-primary btn-xs"><i class="fa fa-github-square fa-2x"></i></a>



			<div class="alert alert-info alert-dismissable" style="margin-top:25px;margin-bottom:5px;">
				<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
				<strong>Hey, hacker!</strong><br>
				You should follow me to get new updates!
			</div>
		</div>
	</div>

		</div>
	</div>

	<div class="row">
		<hr>

	<a name="comments"></a>
<section class="post-comments">
	<h3>Comments</h3>






	

	


	<p>Nothing yet.</p>

	<hr />
	<a name="comment"></a>
	<h3>Post a comment</h3>
	<form class="post-new-comment" method="POST" action="https://api.staticman.net/v2/entry/purpleidea/purpleidea.com/master/comments">
		<input type="hidden" name="options[redirect]" value="https://purpleidea.com/blog/2012/11/14/setting-timed-events-in-puppet/#comment-submitted">
		<input type="hidden" name="options[entryId]" value="blog/2012/11/14/setting-timed-events-in-puppet">
		<div class="col-md-9">
			<div class="row">
				<textarea name="fields[message]" style="width: 80%; height: 50px;" class="post-comment-field" placeholder="Please enter your comment here..." rows="10"></textarea><br />
			</div>
			<div class="row">
				<input name="fields[name]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your name">
			</div>
			<div class="row">
				<input name="fields[email]" type="email" style="width: 50%;" class="post-comment-field" placeholder="Your email address">
			</div>
			<div class="row">
				<input name="fields[url]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your website">
			</div>
			<div class="row">
				<input type="submit" style="width: 80%;" class="post-comment-field btn btn-primary btn-xs" value="Submit">
			</div>
		</div>
	</form>
</section>

<div id="comment-submitted" class="dialog">
	<hr />
	<h3>Thank you</h3>
	<p>Your comment has been submitted and will be published if it gets approved.</p>
	<p><a href="https://github.com/purpleidea/purpleidea.com/pulls">Click here</a> to see the patch you generated.</p>
	<p><a href="#" class="btn">OK</a></p>
</div>

	</div>
		<footer>
		<div class="row">
			<hr>
			<div class="col-sm-12">
				<p>
				&copy; James Shubin 2018 &middot;
				<a href="https://purpleidea.com/">https://purpleidea.com/</a> &middot;
				<a href="https://github.com/purpleidea/purpleidea.com/blob/master/content/blog/2012/11/14/setting-timed-events-in-puppet.md" style="color:grey">Edit this page</a>
				</p>
			</div>
		</div>
		</footer>
	</div>

	<script src="/js/jquery-1.11.3.min.js"></script>
	<script src="/js/bootstrap.js"></script>
</body>
</html>

