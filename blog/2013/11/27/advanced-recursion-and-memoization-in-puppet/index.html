<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="James Shubin">

	<title>Advanced recursion and memoization in Puppet - https://purpleidea.com/</title>
	<link rel="canonical" href="https://purpleidea.com/blog/2013/11/27/advanced-recursion-and-memoization-in-puppet/">

	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/font-awesome.css" rel="stylesheet">
	<link href="/css/custom.css" rel="stylesheet">
	<link href="/css/staticman.css" rel="stylesheet">

	
</head>
<body>
	<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
					<span class="sr-only">Toggle Navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="https://purpleidea.com/">purpleidea.com</a>
			</div>
			<div class="collapse navbar-collapse navbar-ex1-collapse">
				<ul class="nav navbar-nav">

					<li><a href="/about/">about</a></li>
					<li><a href="/blog/">blog</a></li>
					<li><a href="/contact/">contact</a></li>
					<li><a href="/misc/">misc</a></li>
					<li><a href="/talks/">talks</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container">

	<div class="row">
		<div class="col-md-9">
			<div class="well well-sm">
					<h3><strong>Advanced recursion and memoization in Puppet</strong><br><small></small></h3>
					<hr>
					<p>As a follow-up to my original article on <a title="recursion in puppet (for no particular reason)" href="/blog/2012/11/20/recursion-in-puppet-for-no-particular-reason/">recursion in Puppet</a>, and in my attempt to <a title="Pushing Puppet at Puppet Camp DC, LISA 2013" href="/blog/2013/11/05/pushing-puppet-at-puppet-camp-dc-lisa-2013/">Push Puppet (to its limit)</a>, I&rsquo;ll now attempt some more advanced recursion techniques in Puppet.</p>

<p>In my original <a href="https://github.com/purpleidea/puppet-pushing/blob/master/standalone/recursion.pp">recursion example</a>, the type does recurse, but the <em>callee</em> cannot return any value to the <em>caller</em> because it is a type, and not strictly a function. This limitation immediately limits the usefulness of this technique, but I&rsquo;ll try to press on! Let&rsquo;s try to write a <a href="https://en.wikipedia.org/wiki/Fibonacci_number">Fibonacci series</a> function in native Puppet.</p>

<p>For those who aren&rsquo;t familiar, the <a href="https://en.wikipedia.org/wiki/Fibonacci_number">Fibonacci series</a> function is a canonical computer science <a href="https://en.wikipedia.org/wiki/Recursion">recursion</a> example. It is very easy to write as pseudo-code or to implement in python:</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">F</span>(n):
	<span style="color:#66d9ef">if</span> n <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>: <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
	<span style="color:#66d9ef">elif</span> n <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>: <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
	<span style="color:#66d9ef">else</span>: <span style="color:#66d9ef">return</span> F(n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">+</span>F(n<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>)</code></pre></div>
<a href="https://github.com/purpleidea/puppet-pushing/blob/master/standalone/fibonacci.py">You can download this function here.</a> Let&rsquo;s run that script to get a table of the first few values in the Fibonacci series:</p>

<pre><code>$ ./fibonacci.py
F(0) == 0
F(1) == 1
F(2) == 1
F(3) == 2
F(4) == 3
F(5) == 5
F(6) == 8
F(7) == 13
F(8) == 21
F(9) == 34
F(10) == 55
F(11) == 89
F(12) == 144
F(13) == 233
...
</code></pre>

<p>Now, I&rsquo;ll introduce my Puppet implementation:</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e">#!/usr/bin/puppet apply</span>
<span style="color:#66d9ef">class</span> fibdir {
	<span style="color:#75715e"># memoization directory</span>
	file { <span style="color:#e6db74">&#39;/tmp/fibonacci/&#39;</span>:
		<span style="color:#66d9ef">ensure</span> <span style="color:#f92672">=&gt;</span> directory,
	}
}

define fibonacci(
	$n,
	$intermediate <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span> <span style="color:#75715e"># used for pretty printing</span>
) {
	<span style="color:#66d9ef">include</span> fibdir

	$vardir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/tmp&#39;</span>
	$fibdir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${vardir}/fibonacci&#34;</span>

	<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;${n}&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;0&#39;</span> {
		<span style="color:#75715e"># 0</span>
		exec { <span style="color:#e6db74">&#34;${name}: F(0)&#34;</span>:
			command <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;/bin/echo 0 &gt; ${fibdir}/0&#34;</span>,
			creates <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;${fibdir}/0&#34;</span>,
			require <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">File</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#34;${fibdir}/&#34;</span><span style="color:#f92672">]</span>,
		}

	} <span style="color:#66d9ef">elsif</span> <span style="color:#e6db74">&#34;${n}&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;1&#39;</span> {
		<span style="color:#75715e"># 1</span>
		exec { <span style="color:#e6db74">&#34;${name}: F(1)&#34;</span>:
			command <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;/bin/echo 1 &gt; ${fibdir}/1&#34;</span>,
			creates <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;${fibdir}/1&#34;</span>,
			require <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">File</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#34;${fibdir}/&#34;</span><span style="color:#f92672">]</span>,
		}

	} <span style="color:#66d9ef">else</span> {

		$minus1 <span style="color:#f92672">=</span> inline_template(<span style="color:#e6db74">&#39;&lt;%= n.to_i - 1 %&gt;&#39;</span>)
		fibonacci { <span style="color:#e6db74">&#34;${name}: F(${n}-1)&#34;</span>:
			n <span style="color:#f92672">=&gt;</span> $minus1,
			intermediate <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>,
		}

		$minus2 <span style="color:#f92672">=</span> inline_template(<span style="color:#e6db74">&#39;&lt;%= n.to_i - 2 %&gt;&#39;</span>)
		fibonacci { <span style="color:#e6db74">&#34;${name}: F(${n}-2)&#34;</span>:
			n <span style="color:#f92672">=&gt;</span> $minus2,
			intermediate <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>,
		}

		<span style="color:#75715e"># who can figure out what the problem with this is ?</span>
		$fn1 <span style="color:#f92672">=</span> inline_template(<span style="color:#e6db74">&#39;&lt;%= f1=fibdir+&#34;/&#34;+minus1; (File.exist?(f1) ? File.open(f1, &#34;r&#34;).read.to_i : -1) %&gt;&#39;</span>)
		$fn2 <span style="color:#f92672">=</span> inline_template(<span style="color:#e6db74">&#39;&lt;%= f2=fibdir+&#34;/&#34;+minus2; (File.exist?(f2) ? File.open(f2, &#34;r&#34;).read.to_i : -1) %&gt;&#39;</span>)

		<span style="color:#66d9ef">if</span> ((<span style="color:#e6db74">&#34;${fn1}&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;-1&#39;</span>) <span style="color:#f92672">or</span> (<span style="color:#e6db74">&#34;${fn2}&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;-1&#39;</span>)) {
			$fn <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;-1&#39;</span>
		} <span style="color:#66d9ef">else</span> {
			$fn <span style="color:#f92672">=</span> inline_template(<span style="color:#e6db74">&#39;&lt;%= fn1.to_i+fn2.to_i %&gt;&#39;</span>)
		}

		<span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;${fn}&#34;</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;-1&#39;</span> { <span style="color:#75715e"># did the lookup work ?</span>
			<span style="color:#75715e"># store fibonacci number in &#39;table&#39; (memoization)</span>
			exec { <span style="color:#e6db74">&#34;${name}: F(${n})&#34;</span>:
				command <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;/bin/echo ${fn} &gt; ${fibdir}/${n}&#34;</span>,
				creates <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;${fibdir}/${n}&#34;</span>,
				require <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span>
					<span style="color:#66d9ef">File</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#34;${fibdir}/&#34;</span><span style="color:#f92672">]</span>,
					<span style="color:#66d9ef">Fibonacci</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#34;${name}: F(${n}-1)&#34;</span><span style="color:#f92672">]</span>,
					<span style="color:#66d9ef">Fibonacci</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#34;${name}: F(${n}-2)&#34;</span><span style="color:#f92672">]</span>,
				<span style="color:#f92672">]</span>,
			}

			<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span> $intermediate {
				<span style="color:#75715e"># display...</span>
				notify { <span style="color:#e6db74">&#34;F(${n})&#34;</span>:
					message <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;F(${n}) == ${fn}&#34;</span>,
					require <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">Exec</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#34;${name}: F(${n})&#34;</span><span style="color:#f92672">]</span>,
				}
			}
		}
	}
}

<span style="color:#75715e"># kick it off...</span>
fibonacci { <span style="color:#e6db74">&#39;start&#39;</span>:
	n <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">8</span>,
}</code></pre></div>
<a href="https://github.com/purpleidea/puppet-pushing/blob/master/standalone/fibonacci.pp">It is available for download.</a> Try to read through the code yourself first. As you&rsquo;ll see, if called with <em>n == 0</em>, or <em>n == 1</em>, the function creates a file with this value and exits. This is the secret to how the function (the type) passes values around. It first stores them in files, and then loads them in through templates.</p>

<p>Each time this runs, Puppet will complete the next step in the execution. To make this successive execution automatic, I&rsquo;ve <a href="https://github.com/purpleidea/puppet-pushing/blob/master/standalone/fibonacci.sh">written a small bash wrapper</a> to do this, but you can run it manually too. If you do use my wrapper, use it with the <a href="https://github.com/purpleidea/puppet-pushing/blob/master/standalone/fibonacci.pp">fibonacci.pp file provided in git</a>.</p>

<p>The <em>computer scientist</em> might notice that as a side effect, we are actually <a href="https://en.wikipedia.org/wiki/Memoization"><em>memoizing</em></a>. This means that if we run this type again with a larger input value, the previously completed intermediate step values are used as a starting point for the subsequent computations. Cool!</p>

<p>The <em>Puppet wizard</em> might notice that I cheated slightly. Take a minute to try to see where&hellip;</p>

<p><table style="text-align:center; width:80%; margin:0 auto;"><tr><td><a href="muppets-clock.png"><img class="size-full wp-image-618" alt="[IMAGE OF TIME PASSING]" src="muppets-clock.png" width="100%" height="100%" /></a></td></tr><tr><td>(IMAGE OF TIME PASSING)</td></tr></table></br /></p>

<p>Have you figured it out? The problem with the current implementation is that it will only work when run locally as a standalone Puppet program. The reason, is that <em>exec</em> types run on the client, and the <em>templates</em> run on the server. This type requires that both of those elements run on the same machine so that the save/load memoization can work correctly. Since this code runs on the same machine, this isn&rsquo;t a problem! This split execution model is one of the features that can confuse new Puppet users.</p>

<p>To adapt our function (technically a type) to work in any environment, we need to do some more hacking! We can continue to use our <em>exec</em> type for saving, but a <em>fact</em> needs to be used to <a href="https://github.com/purpleidea/puppet-pushing/blob/master/lib/facter/fibonacci.rb">load in the necessary values</a>:</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">require <span style="color:#e6db74">&#39;facter&#39;</span>

fibdir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/tmp/fibonacci/&#39;</span>
valid_fibdir <span style="color:#f92672">=</span> fibdir<span style="color:#f92672">.</span>gsub(<span style="color:#e6db74">/\/$/</span>, <span style="color:#e6db74">&#39;&#39;</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#75715e"># ensure trailing slash</span>

results <span style="color:#f92672">=</span> {} <span style="color:#75715e"># create list of values</span>

<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>directory?(valid_fibdir)
	<span style="color:#66d9ef">Dir</span><span style="color:#f92672">.</span>glob(valid_fibdir<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;*&#39;</span>)<span style="color:#f92672">.</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>f<span style="color:#f92672">|</span>
		b <span style="color:#f92672">=</span> <span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>basename(f)
		i <span style="color:#f92672">=</span> b<span style="color:#f92672">.</span>to_i <span style="color:#75715e"># invalid returns 0</span>
		<span style="color:#66d9ef">if</span> b <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">or</span> i <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>
			v <span style="color:#f92672">=</span> <span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>open(f, <span style="color:#e6db74">&#39;r&#39;</span>)<span style="color:#f92672">.</span>read<span style="color:#f92672">.</span>strip<span style="color:#f92672">.</span>to_i <span style="color:#75715e"># read into int</span>
			results<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> v
		<span style="color:#66d9ef">end</span>
	<span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

results<span style="color:#f92672">.</span>keys<span style="color:#f92672">.</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>x<span style="color:#f92672">|</span>
	<span style="color:#66d9ef">Facter</span><span style="color:#f92672">.</span>add(<span style="color:#e6db74">&#39;pushing_fibonacci_&#39;</span><span style="color:#f92672">+</span>x<span style="color:#f92672">.</span>to_s) <span style="color:#66d9ef">do</span>
		setcode {
			results<span style="color:#f92672">[</span>x<span style="color:#f92672">]</span>
		}
	<span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span></code></pre></div>
The templates from the first version of this type need to be replaced with <a href="https://github.com/purpleidea/puppet-pushing/blob/master/manifests/fibonacci.pp">fact variable lookups</a>:</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># these are &#39;fact&#39; lookups</span>
$fn1 <span style="color:#f92672">=</span> getvar(<span style="color:#e6db74">&#34;pushing_fibonacci_${minus1}&#34;</span>)
$fn2 <span style="color:#f92672">=</span> getvar(<span style="color:#e6db74">&#34;pushing_fibonacci_${minus2}&amp;quot;)</span></code></pre></div>
You can use git to download all of this code as a <a href="https://github.com/purpleidea/puppet-pushing">module</a>.</p>

<p>I hope you enjoyed this. Please let me know! <a href="#comments">Comment below</a>, or <a href="/contact/">send me a message</a>.</p>

<p>Happy hacking,</p>

<p>James</p>

<p>P.S.: While I think this is fun, I wrote this hack to demonstrate some techniques, and to set the stage for future hacks, future techniques, and future Puppet examples. If you&rsquo;re using this as a good way to actually compute values in the Fibonacci series, you&rsquo;re insane!</p>

<p>P.P.S.: The word is actually <a href="https://en.wikipedia.org/wiki/Memoization"><em>memoization</em></a>, <strong>not</strong> <em>memorization</em>, despite the similarities between the two words, and the two concepts.</p>

<p>P.P.P.S: <a href="http://www.gluster.org/blog/">Gluster</a> users get extra points if they can figure out how this will lead to a feature for <a title="puppet-gluster" href="https://github.com/purpleidea/puppet-gluster/">Puppet-Gluster</a>. It&rsquo;s a bit tricky to see if you&rsquo;re not following my <a href="https://github.com/purpleidea/">git commits</a>.</p>

			</div>
		</div>

		
		<div class="col-md-3">
			<div class="well well-sm"> 
				<h4>November 27, 2013<br>
				<small>998 words</small></h4>
				<hr>
				<strong>Categories</strong>
				<ul class="list-unstyled">
				
					<li><a href="/categories/technical">technical</a></li>
				
				</ul>
				<hr>
				<strong>Tags</strong><br>
				<a class="label label-default" href="/tags/devops">devops</a> <a class="label label-default" href="/tags/fibonacci">fibonacci</a> <a class="label label-default" href="/tags/gluster">gluster</a> <a class="label label-default" href="/tags/memoization">memoization</a> <a class="label label-default" href="/tags/planetfedora">planetfedora</a> <a class="label label-default" href="/tags/planetpuppet">planetpuppet</a> <a class="label label-default" href="/tags/puppet">puppet</a> <a class="label label-default" href="/tags/recursion">recursion</a> 
				
				<hr>
				<strong>Original URL</strong><br>
				<a href="https://ttboj.wordpress.com/2013/11/27/advanced-recursion-and-memoization-in-puppet/"><small>https://ttboj.wordpress.com/2013/11/27/advanced-recursion-and-memoization-in-puppet/</small></a>
				

				
			</div>
				<div class="panel panel-default">
		<div class="panel-heading" style="padding: 2px 15px;">
			<h4>Oh hello...</h4>
		</div>
		<div class="panel-body">

			<a href="https://twitter.com/purpleidea" class="btn btn-info btn-xs"><i class="fa fa-twitter-square fa-2x"></i></a>


			<a href="https://github.com/purpleidea/" class="btn btn-primary btn-xs"><i class="fa fa-github-square fa-2x"></i></a>



			<div class="alert alert-info alert-dismissable" style="margin-top:25px;margin-bottom:5px;">
				<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
				<strong>Hey, hacker!</strong><br>
				You should follow me to get new updates!
			</div>
		</div>
	</div>

		</div>
	</div>

	<div class="row">
		<hr>

	<a name="comments"></a>
<section class="post-comments">
	<h3>Comments</h3>






	

	


	<p>Nothing yet.</p>

	<hr />
	<a name="comment"></a>
	<h3>Post a comment</h3>
	<form class="post-new-comment" method="POST" action="https://api.staticman.net/v2/entry/purpleidea/purpleidea.com/master/comments">
		<input type="hidden" name="options[redirect]" value="https://purpleidea.com/blog/2013/11/27/advanced-recursion-and-memoization-in-puppet/#comment-submitted">
		<input type="hidden" name="options[entryId]" value="blog/2013/11/27/advanced-recursion-and-memoization-in-puppet">
		<div class="col-md-9">
			<div class="row">
				<textarea name="fields[message]" style="width: 80%; height: 50px;" class="post-comment-field" placeholder="Please enter your comment here..." rows="10"></textarea><br />
			</div>
			<div class="row">
				<input name="fields[name]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your name">
			</div>
			<div class="row">
				<input name="fields[email]" type="email" style="width: 50%;" class="post-comment-field" placeholder="Your email address">
			</div>
			<div class="row">
				<input name="fields[url]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your website">
			</div>
			<div class="row">
				<input type="submit" style="width: 80%;" class="post-comment-field btn btn-primary btn-xs" value="Submit">
			</div>
		</div>
	</form>
</section>

<div id="comment-submitted" class="dialog">
	<hr />
	<h3>Thank you</h3>
	<p>Your comment has been submitted and will be published if it gets approved.</p>
	<p><a href="https://github.com/purpleidea/purpleidea.com/pulls">Click here</a> to see the patch you generated.</p>
	<p><a href="#" class="btn">OK</a></p>
</div>

	</div>
		<footer>
		<div class="row">
			<hr>
			<div class="col-sm-12">
				<p>
				&copy; James Shubin 2018 &middot;
				<a href="https://purpleidea.com/">https://purpleidea.com/</a> &middot;
				<a href="https://github.com/purpleidea/purpleidea.com/blob/master/content/blog/2013/11/27/advanced-recursion-and-memoization-in-puppet.md" style="color:grey">Edit this page</a>
				</p>
			</div>
		</div>
		</footer>
	</div>

	<script src="/js/jquery-1.11.3.min.js"></script>
	<script src="/js/bootstrap.js"></script>
</body>
</html>

