<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="James Shubin">

	<title>Vagrant on Fedora with libvirt - https://purpleidea.com/</title>
	<link rel="canonical" href="https://purpleidea.com/blog/2013/12/09/vagrant-on-fedora-with-libvirt/">

	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/font-awesome.css" rel="stylesheet">
	<link href="/css/custom.css" rel="stylesheet">
	<link href="/css/staticman.css" rel="stylesheet">

	
</head>
<body>
	<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
					<span class="sr-only">Toggle Navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="https://purpleidea.com/">purpleidea.com</a>
			</div>
			<div class="collapse navbar-collapse navbar-ex1-collapse">
				<ul class="nav navbar-nav">

					<li><a href="/about/">about</a></li>
					<li><a href="/blog/">blog</a></li>
					<li><a href="/contact/">contact</a></li>
					<li><a href="/misc/">misc</a></li>
					<li><a href="/talks/">talks</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container">

	<div class="row">
		<div class="col-md-9">
			<div class="well well-sm">
					<h3><strong>Vagrant on Fedora with libvirt</strong><br><small></small></h3>
					<hr>
					<p>Apparently lots of people are using <a href="https://www.vagrantup.com/">Vagrant</a> these days, so I figured I&rsquo;d try it out. I wanted to get it working on Fedora, and without Virtualbox. This is an intro article on Vagrant, and what I&rsquo;ve done. I did this on Fedora 19. Feel free to suggest improvements.</p>

<p><span style="text-decoration:underline;">Intro</span>:</p>

<p>Vagrant is a tool that easily provisions virtual machines, and then kicks off a configuration management deployment like <a href="https://en.wikipedia.org/wiki/Puppet_%28software%29">Puppet</a>. It&rsquo;s often used for development. I&rsquo;m planning on using it to test some <a title="puppet-gluster" href="https://github.com/purpleidea/puppet-gluster/">Puppet-Gluster</a> managed GlusterFS clusters.</p>

<p><span style="text-decoration:underline;">Installation</span>:</p>

<p>You should already have the base libvirt/QEMU packages already installed (if they&rsquo;re not already present) and be comfortable with basic virtual machine concepts. If not, come back when you&rsquo;re ready.</p>

<p>Fedora 20 was <a href="https://fedoraproject.org/wiki/Changes/Vagrant">supposed to include Vagrant</a>, but I don&rsquo;t think this happened. In the meantime, I installed the latest x86_64 RPM from the Vagrant download page.</p>

<pre><code>$ mkdir ~/vagrant
$ wget http://files.vagrantup.com/packages/a40522f5fabccb9ddabad03d836e120ff5d14093/vagrant_1.3.5_x86_64.rpm
$ sudo yum install vagrant_1.3.5_x86_64.rpm
</code></pre>

<p><em>EDIT</em>: Please use version 1.3.5 only! The 1.4 series breaks compatibility with a lot of the necessary plugins. You might have success with different versions, but I have not tested them yet.</p>

<p>You&rsquo;ll probably need some dependencies for the next few steps. Ensure they&rsquo;re present:</p>

<pre><code>$ sudo yum install libvirt-devel libxslt-devel libxml2-devel
</code></pre>

<p>The <a href="http://libvirt.org/virshcmdref.html"><em>virsh</em></a> and <a href="http://virt-manager.org/"><em>virt-manager</em></a> tools are especially helpful additions. Install those too.</p>

<p><span style="text-decoration:underline;">Boxes</span>:</p>

<p>Vagrant has a concept of default &ldquo;boxes&rdquo;. These are pre-built images that you download, and use as base images for the virtual machines that you&rsquo;ll be building. Unfortunately, they are hypervisor specific, and the most commonly available images have been built for Virtualbox. Yuck! To get around this limitation, there is an easy solution.</p>

<p>First we&rsquo;ll need to install a special <a href="https://github.com/sciurus/vagrant-mutate">Vagrant plugin</a>:</p>

<pre><code>$ sudo yum install qemu-img # depends on this
$ vagrant plugin install vagrant-mutate
</code></pre>

<p><em>EDIT</em>: Note that there is a <a href="https://github.com/sciurus/vagrant-mutate/issues/37">bug</a> on Fedora 20 that breaks mutate! Feel free to skip over the mutate steps below on Fedora, and use <a href="https://dl.fedoraproject.org/pub/alt/purpleidea/vagrant/centos-6/centos-6.box">this</a> image instead. You can install it with:</p>

<pre><code>$ vagrant box add centos-6 https://dl.fedoraproject.org/pub/alt/purpleidea/vagrant/centos-6/centos-6.box --provider=libvirt
</code></pre>

<p>You&rsquo;ll have to replace the <em>precise32</em> name in the below <em>Vagrantfile</em> with <em>centos-6</em>.</p>

<p><em>END EDIT</em></p>

<p>Now download an incompatible box. We&rsquo;ll use the well-known example:</p>

<pre><code>$ vagrant box add precise32 http://files.vagrantup.com/precise32.box
</code></pre>

<p>Finally, convert the box so that it&rsquo;s libvirt compatible:</p>

<pre><code>$ vagrant mutate precise32 libvirt
</code></pre>

<p>This plugin can also convert to KVM friendly boxes.</p>

<p>You&rsquo;ll need to make a working directory for Vagrant and initialize it:</p>

<pre><code>$ mkdir test1
$ cd test1
$ vagrant init precise32
</code></pre>

<p><span style="text-decoration:underline;">Hypervisor</span>:</p>

<p>I initially tried getting this working with the <a href="https://github.com/adrahon/vagrant-kvm">vagrant-kvm</a> plugin that Fedora 20 will eventually include, but I did not succeed. Instead, I used the <a href="https://github.com/pradels/vagrant-libvirt">vagrant-libvirt</a> plugin:</p>

<pre><code>$ vagrant plugin install vagrant-libvirt
</code></pre>

<p><em>EDIT</em>: I forgot to mention that you&rsquo;ll need to specify the <code>&ndash;provider</code> argument when running vagrant commands. I wrote about how to do this in my <a href="/blog/2013/12/21/vagrant-vsftp-and-other-tricks/">second article</a>. You can use <code>&ndash;provider=libvirt</code> for each command or include the:</p>

<pre><code>export VAGRANT_DEFAULT_PROVIDER=libvirt
</code></pre>

<p>line in your ~/.bashrc file.</p>

<p><em>END EDIT</em></p>

<p>I have found a number of issues with it, but I&rsquo;ll show you which magic knobs I&rsquo;ve used so that you can replicate my setup. Let me show you my <em>Vagrantfile</em>:</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># -*- mode: ruby -*-</span>
<span style="color:#75715e"># vi: set ft=ruby :</span>

<span style="color:#66d9ef">VAGRANTFILE_API_VERSION</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2&#34;</span>

<span style="color:#75715e"># NOTE: vagrant-libvirt needs to run in series (not in parallel) to avoid</span>
<span style="color:#75715e"># trying to create the network twice... eg: vagrant up --no-parallel</span>
<span style="color:#75715e"># alternatively, you can just create the vm&#39;s one at a time manually...</span>

<span style="color:#66d9ef">Vagrant</span><span style="color:#f92672">.</span>configure(<span style="color:#66d9ef">VAGRANTFILE_API_VERSION</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>config<span style="color:#f92672">|</span>

	<span style="color:#75715e"># Every Vagrant virtual environment requires a box to build from</span>
	config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>box <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;precise32&#34;</span>			<span style="color:#75715e"># choose your own!</span>

	<span style="color:#75715e"># List each virtual machine</span>
	config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>define <span style="color:#e6db74">:vm1</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>vm1<span style="color:#f92672">|</span>
		vm1<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>network <span style="color:#e6db74">:private_network</span>,
			<span style="color:#e6db74">:ip</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;192.168.142.101&#34;</span>,	<span style="color:#75715e"># choose your own!</span>
			<span style="color:#e6db74">:libvirt__network_name</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;default&#34;</span>	<span style="color:#75715e"># leave it</span>
	<span style="color:#66d9ef">end</span>

	config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>define <span style="color:#e6db74">:vm2</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>vm2<span style="color:#f92672">|</span>
		vm2<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>network <span style="color:#e6db74">:private_network</span>,
			<span style="color:#e6db74">:ip</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;192.168.142.102&#34;</span>,	<span style="color:#75715e"># choose your own!</span>
			<span style="color:#e6db74">:libvirt__network_name</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;default&#34;</span>	<span style="color:#75715e"># leave it</span>
	<span style="color:#66d9ef">end</span>

	<span style="color:#75715e"># Provider-specific configuration</span>
	config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provider <span style="color:#e6db74">:libvirt</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>libvirt<span style="color:#f92672">|</span>
		libvirt<span style="color:#f92672">.</span>driver <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;qemu&#34;</span>
		<span style="color:#75715e"># leave out host to connect directly with qemu:///system</span>
		<span style="color:#75715e">#libvirt.host = &#34;localhost&#34;</span>
		libvirt<span style="color:#f92672">.</span>connect_via_ssh <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>		<span style="color:#75715e"># also needed</span>
		libvirt<span style="color:#f92672">.</span>username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;root&#34;</span>
		libvirt<span style="color:#f92672">.</span>storage_pool_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;default&#34;</span>
	<span style="color:#66d9ef">end</span>

	<span style="color:#75715e"># Enable provisioning with Puppet. You might want to use the agent!</span>
	config<span style="color:#f92672">.</span>vm<span style="color:#f92672">.</span>provision <span style="color:#e6db74">:puppet</span> <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>puppet<span style="color:#f92672">|</span>
		puppet<span style="color:#f92672">.</span>module_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;modules&#34;</span>
		puppet<span style="color:#f92672">.</span>manifests_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;manifests&#34;</span>
		puppet<span style="color:#f92672">.</span>manifest_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;site.pp&#34;</span>
		<span style="color:#75715e"># custom fact</span>
		puppet<span style="color:#f92672">.</span>facter <span style="color:#f92672">=</span> {
			<span style="color:#e6db74">&#34;vagrant&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;1&#34;</span>,
		}
	<span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span></code></pre></div>
A few caveats:
<ul>
    <li>The <code>:libvirt__network_name =&gt; &ldquo;default&rdquo;</code> needs to always be specified. If you don&rsquo;t specify it, or if you specify a different name, you&rsquo;ll get an error:</p>

<pre><code>Call to virDomainCreateWithFlags failed: Network not found: no network with matching name 'default'
</code></pre>

<p></li>
    <li>With this <em>Vagrantfile</em>, you&rsquo;ll get an IP address from DHCP, and a static IP address from the <em>:ip</em> definition. If you attempt to disable DHCP with <code>:libvirt__dhcp_enabled =&gt; false</code> you&rsquo;ll see errors:</p>

<pre><code>grep: /var/lib/libvirt/dnsmasq/*.leases: No such file or directory
</code></pre>

<p>As a result, each machine will have two IP addresses.</li>
    <li>Running <em>vagrant up</em> caused some errors when more than one machine is defined. This was caused by duplicate attempts to create the same network. To work around this, you can either start each virtual machine manually, or use the &ndash;no-parallel option when the network is first created:</p>

<pre><code>$ vagrant up --no-parallel
&lt;em&gt;[...]&lt;/em&gt;
&lt;&lt;a href=&quot;https://www.youtube.com/watch?v=MnA4u9CaK7A&amp;html5=1&quot;&gt;magic awesome happens here&lt;/a&gt;&gt;
</code></pre>

<p></li>
</ul>
<span style="text-decoration:underline;">Commands</span>:</p>

<p>The most common commands you&rsquo;ll need are:
<ul>
    <li><code>vagrant init</code> – initialize a directory</li>
    <li><code>vagrant up [machine]</code> – start/build/deploy a machine</li>
    <li><code>vagrant ssh <machine></code> – connect to a machine</li>
    <li><code>vagrant halt [machine]</code> – stop the machine</li>
    <li><code>vagrant destroy [machine]</code> – remove/erase/purge the entire machine</li>
</ul>
I won&rsquo;t go into further details here, because this information is <a href="http://docs.vagrantup.com/v2/">well documented</a>.</p>

<p><span style="text-decoration:underline;">PolicyKit (polkit)</span>:</p>

<p>At this point you&rsquo;re probably getting annoyed by having to repeatedly type your password to interact with your VM through libvirt. You&rsquo;re probably seeing a dialog like this:</p>

<p><table style="text-align:center; width:80%; margin:0 auto;"><tr><td><a href="screenshot-authenticate.png"><img class="alignnone size-full wp-image-635" alt="Screenshot-Authenticate" src="screenshot-authenticate.png" width="100%" height="100%" /></a></td></tr></table></br /></p>

<p>This should look familiar if you&rsquo;ve used <em>virt-manager</em> before. When you open <em>virt-manager</em>, and it tries to connect to <code>qemu:///system</code>, PolicyKit does the <em>right thing</em> and ensures that you&rsquo;re allowed to get access to the resource first! The annoying part is that you get repeatedly prompted when you&rsquo;re using <em>Vagrant</em>, because it is constantly opening up and closing new connections. If you&rsquo;re comfortable allowing this permanently, you can add a policy file:</p>

<pre><code>[Allow james libvirt management permissions]
Identity=unix-user:james
Action=org.libvirt.unix.manage
ResultAny=yes
ResultInactive=yes
ResultActive=yes
</code></pre>

<p>Create this file (you&rsquo;ll need root) as:</p>

<pre><code>/etc/polkit-1/localauthority/50-local.d/vagrant.pkla
</code></pre>

<p>and then shouldn&rsquo;t experience any more prompts when you try to manage libvirt! You&rsquo;ll obviously want to replace the <em><strong>james</strong></em> string with whatever user account you&rsquo;re using. For more information on the format of this file, and to learn other ways to do this read the <a href="http://www.freedesktop.org/software/polkit/docs/0.105/pklocalauthority.8.html">pkla documentation</a>.</p>

<p>If you want to avoid PolicyKit, you can connect to <em>libvirtd</em> over SSH, however I don&rsquo;t have <em>sshd</em> running on my laptop, and I wanted to connect directly. The default vagrant-libvirt example demonstrates this method.</p>

<p><span style="text-decoration:underline;">Puppet</span>:</p>

<p>Provisioning machines without configuration management wouldn&rsquo;t be very useful. Thankfully, <em>Vagrant</em> integrates nicely with Puppet. The documentation on this is fairly straightforward, so I won&rsquo;t cover this part. I show a simple Puppet deployment in my <em>Vagrantfile</em> above, but a more complex setup involving <code>puppet agent</code> and <em>puppetmasterd</em> is possible too.</p>

<p><span style="text-decoration:underline;">Conclusion</span>:</p>

<p>Hopefully this makes it easier for you to hack in GNU/Linux land. I look forward to seeing this supported natively in Fedora, but until then, hopefully I&rsquo;ve helped out with the heavy lifting.</p>

<p>Happy hacking!</p>

<p>James</p>

			</div>
		</div>

		
		<div class="col-md-3">
			<div class="well well-sm"> 
				<h4>December 9, 2013<br>
				<small>1208 words</small></h4>
				<hr>
				<strong>Categories</strong>
				<ul class="list-unstyled">
				
					<li><a href="/categories/technical">technical</a></li>
				
				</ul>
				<hr>
				<strong>Tags</strong><br>
				<a class="label label-default" href="/tags/devops">devops</a> <a class="label label-default" href="/tags/fedora">fedora</a> <a class="label label-default" href="/tags/gluster">gluster</a> <a class="label label-default" href="/tags/libvirt">libvirt</a> <a class="label label-default" href="/tags/pkla">pkla</a> <a class="label label-default" href="/tags/planetfedora">planetfedora</a> <a class="label label-default" href="/tags/planetpuppet">planetpuppet</a> <a class="label label-default" href="/tags/policykit">policykit</a> <a class="label label-default" href="/tags/polkit">polkit</a> <a class="label label-default" href="/tags/puppet">puppet</a> <a class="label label-default" href="/tags/puppet-gluster">puppet-gluster</a> <a class="label label-default" href="/tags/vagrant">vagrant</a> <a class="label label-default" href="/tags/virsh">virsh</a> <a class="label label-default" href="/tags/virt-manager">virt-manager</a> 
				
				<hr>
				<strong>Original URL</strong><br>
				<a href="https://ttboj.wordpress.com/2013/12/09/vagrant-on-fedora-with-libvirt/"><small>https://ttboj.wordpress.com/2013/12/09/vagrant-on-fedora-with-libvirt/</small></a>
				

				
			</div>
				<div class="panel panel-default">
		<div class="panel-heading" style="padding: 2px 15px;">
			<h4>Oh hello...</h4>
		</div>
		<div class="panel-body">

			<a href="https://twitter.com/purpleidea" class="btn btn-info btn-xs"><i class="fa fa-twitter-square fa-2x"></i></a>


			<a href="https://github.com/purpleidea/" class="btn btn-primary btn-xs"><i class="fa fa-github-square fa-2x"></i></a>



			<div class="alert alert-info alert-dismissable" style="margin-top:25px;margin-bottom:5px;">
				<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
				<strong>Hey, hacker!</strong><br>
				You should follow me to get new updates!
			</div>
		</div>
	</div>

		</div>
	</div>

	<div class="row">
		<hr>

	<a name="comments"></a>
<section class="post-comments">
	<h3>Comments</h3>






	


	<p>Nothing yet.</p>

	<hr />
	<a name="comment"></a>
	<h3>Post a comment</h3>
	<form class="post-new-comment" method="POST" action="https://api.staticman.net/v2/entry/purpleidea/purpleidea.com/master/comments">
		<input type="hidden" name="options[redirect]" value="https://purpleidea.com/blog/2013/12/09/vagrant-on-fedora-with-libvirt/#comment-submitted">
		<input type="hidden" name="options[entryId]" value="blog/2013/12/09/vagrant-on-fedora-with-libvirt">
		<div class="col-md-9">
			<div class="row">
				<textarea name="fields[message]" style="width: 80%; height: 50px;" class="post-comment-field" placeholder="Please enter your comment here..." rows="10"></textarea><br />
			</div>
			<div class="row">
				<input name="fields[name]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your name">
			</div>
			<div class="row">
				<input name="fields[email]" type="email" style="width: 50%;" class="post-comment-field" placeholder="Your email address">
			</div>
			<div class="row">
				<input name="fields[url]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your website">
			</div>
			<div class="row">
				<input type="submit" style="width: 80%;" class="post-comment-field btn btn-primary btn-xs" value="Submit">
			</div>
		</div>
	</form>
</section>

<div id="comment-submitted" class="dialog">
	<hr />
	<h3>Thank you</h3>
	<p>Your comment has been submitted and will be published if it gets approved.</p>
	<p><a href="https://github.com/purpleidea/purpleidea.com/pulls">Click here</a> to see the patch you generated.</p>
	<p><a href="#" class="btn">OK</a></p>
</div>

	</div>
		<footer>
		<div class="row">
			<hr>
			<div class="col-sm-12">
				<p>
				&copy; James Shubin 2018 &middot;
				<a href="https://purpleidea.com/">https://purpleidea.com/</a> &middot;
				<a href="https://github.com/purpleidea/purpleidea.com/blob/master/content/blog/2013/12/09/vagrant-on-fedora-with-libvirt.md" style="color:grey">Edit this page</a>
				</p>
			</div>
		</div>
		</footer>
	</div>

	<script src="/js/jquery-1.11.3.min.js"></script>
	<script src="/js/bootstrap.js"></script>
</body>
</html>

